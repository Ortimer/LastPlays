/*!Wed Apr 30 2014 20:07:00 */
window.LastPlaysGamesByBGGUser={},LastPlaysGamesByBGGUser.Views={},LastPlaysGamesByBGGUser.Collections={},LastPlaysGamesByBGGUser.Models={},LastPlaysGamesByBGGUser.Routers={},window.app={},window.routers={},window.plugs={},window.views={},window.collections={},$(document).ready(function(){window.views.inputForm=new LastPlaysGamesByBGGUser.Views.InputFormView($("#contenido")),window.views.orderFilter=new LastPlaysGamesByBGGUser.Views.OrderFilterView,window.collections.gamePlays=new LastPlaysGamesByBGGUser.Collections.GamePlaysCollection,window.routers=new LastPlaysGamesByBGGUser.Routers.MainRouter,Backbone.history.start({root:"/",pushState:!0,silent:!1})}),LastPlaysGamesByBGGUser.Models.GameItemModel=Backbone.Model.extend({urlRoot:"/",defaults:{},prettyDate:function(a){if(!a||"0000-00-00 00:00:00"===a)return"";var a=Date.parse(a);return a.toString("MMMM dd, yyyy")},parse:function(a){return a.data?a.data:a}}),LastPlaysGamesByBGGUser.Models.GameItem=LastPlaysGamesByBGGUser.Models.GameItemModel,LastPlaysGamesByBGGUser.Collections.GamePlaysCollection=Backbone.Collection.extend({model:LastPlaysGamesByBGGUser.Models.GameItemModel,url:"",name:"Plays",search:function(a){if(""==a)return this;var b=new RegExp(a,"gi");return _(this.filter(function(a){return b.test(a.get("title"))}))},comparator:function(a){return a.get("title")},getOne:function(a){return this.filter(function(b){return b.get("id")==a})},parse:function(a){return a.data},render:function(){$("#contenido").html(""),this.each(function(a){var b=new LastPlaysGamesByBGGUser.Views.PlaysView(a);b.render(),b.$el.appendTo("#contenido")})},getComparator:function(a,b){var c="";switch(a){case"Days":c="timeMilis";break;case"Name":c="title";break;case"Plays":c="totalPlays"}return function(d,e){return"Ascending"===b?"Name"===a?d.get(c).localeCompare(e.get(c)):d.get(c)-e.get(c):"Name"===a?e.get(c).localeCompare(d.get(c)):e.get(c)-d.get(c)}}}),LastPlaysGamesByBGGUser.Collections.gamePlays=LastPlaysGamesByBGGUser.Collections.GamePlaysCollection,LastPlaysGamesByBGGUser.Routers.MainRouter=Backbone.Router.extend({routes:{"":"root","plays/:bggUser":"showPlays"},initialize:function(){},root:function(){window.views.orderFilter.remove(),window.views.inputForm.render()},showPlays:function(a){var b=this,c=null,d={lines:11,length:25,width:12,radius:40,corners:1,rotate:0,color:"#000",speed:1,trail:60,shadow:!0,hwaccel:!1,className:"spinner",zIndex:2e9,top:"50%",left:"50%",visibility:!0};$("#contenido").html(new Spinner(d).spin().el);var e="/bggData/collection?username="+a;null!=$.cookie(a)&&(c=JSON.parse($.cookie(a))),null==c&&(c={bggUser:a,orderBy:"Days",orderType:"Descending",onlyOwned:!0,excludeExp:!0,onlyPlayed:!0}),c.onlyOwned&&(e+="&own=1"),c.excludeExp&&(e+="&excludesubtype=boardgameexpansion"),c.onlyPlayed&&(e+="&played=1"),window.collections.gamePlays.comparator=window.collections.gamePlays.getComparator(c.orderBy,c.orderType),window.collections.gamePlays.reset(),this.ajaxCollection(b,a,e)},ajaxCollection:function(a,b,c){$.ajax({url:c,dataType:"xml",type:"GET",success:function(c){var d=[],e=[],f=$(c);f.find("items").find("item").each(function(){d.push($(this).attr("objectid")),e[$(this).attr("objectid")]={id:$(this).attr("objectid"),title:$(this).find("name").text(),image:$(this).find("thumbnail").text(),lastPlay:"No play has been recorded",time:"N/A",timeMilis:-1,totalPlays:$(this).find("numplays").text()}}),a.ajaxPlays(a,b,1,d,e)},error:function(a){console.log("Error in ajaxCollection"),console.log(a)}})},ajaxPlays:function(a,b,c,d,e){var f="/bggData/plays?username="+b+"&page="+c;$.ajax({url:f,dataType:"xml",type:"GET",success:function(f){var g=$(f),h=null;if(g.find("plays").children().length>0){var i=g.find("plays").attr("userid");g.find("plays").find("play").each(function(){if(h=$(this).find("item").attr("objectid"),-1!=$.inArray(h,d)&&("No play has been recorded"==e[h].lastPlay||e[h].lastPlay<$(this).attr("date"))){e[h].userId=i,e[h].lastPlay=$(this).attr("date");var a=new Date,b=new Date(e[h].lastPlay.substring(0,4),e[h].lastPlay.substring(5,7)-1,e[h].lastPlay.substring(8,10)),c=new Date(e[h].lastPlay.substring(0,4),e[h].lastPlay.substring(5,7)-1,1),f=12*(a.getFullYear()-b.getFullYear());f-=b.getMonth(),f+=a.getMonth(),b.getDate()>a.getDate()&&(f-=1),0>=f&&(f=0),e[h].timeMilis=a.getTime()-b.getTime();var g=parseInt(f/12),j=f%12;c.setMonth(c.getMonth()+j+12*g),c.setDate(b.getDate());var k=parseInt((a.getTime()-c.getTime())/864e5);e[h].time=g+" year(s) "+j+" month(s) "+k+" day(s)"}}),c++,a.ajaxPlays(a,b,c,d,e)}else{for(key in e){var j=new LastPlaysGamesByBGGUser.Models.GameItem(e[key]);window.collections.gamePlays.add(j)}window.views.orderFilter.render(b),window.views.orderFilter.$el.appendTo("body header"),window.collections.gamePlays.render()}},error:function(a){console.log("Error in ajaxPlays [Page: "+c+"]"),console.log(a)}})}}),LastPlaysGamesByBGGUser.Views.InputFormView=Backbone.View.extend({events:{"click #search":"searchGames","keypress #bggUser":"searchGamesEnter"},className:"",initialize:function(a){this.$el=a,this.template=_.template($("#inputForm_tpl").html())},render:function(){var a={};return this.$el.html(this.template({data:a})),this},searchGames:function(){var a={bggUser:$("#bggUser").val().trim(),orderBy:$("#orderBy").val(),orderType:$("#orderType").val(),onlyOwned:$("#onlyOwned").is(":checked"),excludeExp:$("#excludeExpansions").is(":checked"),onlyPlayed:$("#onlyPlayed").is(":checked")};$("#bggUser").removeClass("badInput"),$("#bggUser").focus(function(){$("#bggUser").removeClass("badInput")}),0==a.bggUser.length?$("#bggUser").addClass("badInput"):($.cookie(a.bggUser,JSON.stringify(a),{expires:365,path:"/"}),Backbone.history.navigate("plays/"+a.bggUser,{trigger:!0}))},searchGamesEnter:function(a){13==a.keyCode&&this.searchGames()}}),LastPlaysGamesByBGGUser.Views.PlaysView=Backbone.View.extend({events:{show:"show",click:"toggleExpand"},className:"",initialize:function(a){this.playData=a,this.expanded=0,this.template=_.template($("#PlaysView_tpl").html())},render:function(){var a={data:this.playData.toJSON()};return this.$el.html(this.template(a)),this},toggleExpand:function(){0==this.expanded?(this.$el.find(".gameItem").attr("class","extendedGameItem"),this.expanded=1):(this.$el.find(".extendedGameItem").attr("class","gameItem"),this.expanded=0)}}),LastPlaysGamesByBGGUser.Views.OrderFilterView=Backbone.View.extend({events:{},className:"",initialize:function(){this.template=_.template($("#OrderFilter_tpl").html())},render:function(a){var b=this,c=null;return this.$el.html(this.template({data:{}})),null!=$.cookie(a)&&(c=JSON.parse($.cookie(a))),null==c&&(c={bggUser:a,orderBy:"Days",orderType:"Descending",onlyOwned:!0,excludeExp:!0,onlyPlayed:!0}),this.$el.find("#filterOrderBy").val(c.orderBy),this.$el.find("#filterOrderType").val(c.orderType),this.$el.find("#filterToggle").on("click",function(){"filterFormShow"===b.$el.find("#filterForm").attr("class")?b.$el.find("#filterForm").attr("class","filterFormHidden"):b.$el.find("#filterForm").attr("class","filterFormShow")}),this.$el.find("#reOrder").on("click",function(){var a=b.$el.find("#filterOrderBy").val(),c=b.$el.find("#filterOrderType").val();window.collections.gamePlays.comparator=window.collections.gamePlays.getComparator(a,c),window.collections.gamePlays.sort(),window.collections.gamePlays.render()}),this}});