/*!Thu Jan 02 2014 09:36:56 */
window.LastPlaysGamesByBGGUser={},LastPlaysGamesByBGGUser.Views={},LastPlaysGamesByBGGUser.Collections={},LastPlaysGamesByBGGUser.Models={},LastPlaysGamesByBGGUser.Routers={},window.app={},window.routers={},window.plugs={},window.views={},window.collections={},$(document).ready(function(){window.views.inputForm=new LastPlaysGamesByBGGUser.Views.InputFormView($("#contenido")),window.views.orderFilter=new LastPlaysGamesByBGGUser.Views.OrderFilterView,window.collections.gamePlays=new LastPlaysGamesByBGGUser.Collections.GamePlaysCollection,window.routers=new LastPlaysGamesByBGGUser.Routers.MainRouter,Backbone.history.start({root:"/",pushState:!0,silent:!1})}),LastPlaysGamesByBGGUser.Models.GameItemModel=Backbone.Model.extend({urlRoot:"/",defaults:{},prettyDate:function(a){if(!a||"0000-00-00 00:00:00"===a)return"";var a=Date.parse(a);return a.toString("MMMM dd, yyyy")},parse:function(a){return a.data?a.data:a}}),LastPlaysGamesByBGGUser.Models.GameItem=LastPlaysGamesByBGGUser.Models.GameItemModel,LastPlaysGamesByBGGUser.Collections.GamePlaysCollection=Backbone.Collection.extend({model:LastPlaysGamesByBGGUser.Models.GameItemModel,url:"",name:"Plays",search:function(a){if(""==a)return this;var b=new RegExp(a,"gi");return _(this.filter(function(a){return b.test(a.get("title"))}))},comparator:function(a){return a.get("title")},getOne:function(a){return this.filter(function(b){return b.get("id")==a})},parse:function(a){return a.data},render:function(){$("#contenido").html(""),this.each(function(a){var b=new LastPlaysGamesByBGGUser.Views.PlaysView(a);b.render(),b.$el.appendTo("#contenido")})},getComparator:function(a,b){var c="";switch(a){case"Days":c="timeMilis";break;case"Name":c="title";break;case"Plays":c="totalPlays"}return function(d,e){return"Ascending"===b?"Name"===a?d.get(c).localeCompare(e.get(c)):d.get(c)-e.get(c):"Name"===a?e.get(c).localeCompare(d.get(c)):e.get(c)-d.get(c)}}}),LastPlaysGamesByBGGUser.Collections.gamePlays=LastPlaysGamesByBGGUser.Collections.GamePlaysCollection,LastPlaysGamesByBGGUser.Routers.MainRouter=Backbone.Router.extend({routes:{"":"root","plays/:bggUser":"showPlays"},initialize:function(){},root:function(){window.views.orderFilter.remove(),window.views.inputForm.render()},showPlays:function(a){var b=null,c=[],d=[],e=!0,f=1;$("#contenido").empty().append("<figure id='loadingIcon'><img src='/img/ajax-loader.gif' /></figure>"),$("#contenido").hide(),$("#contenido").show();var g="/bggData/collection?username="+a;for(null!=$.cookie(a)&&(b=JSON.parse($.cookie(a))),null==b&&(b={bggUser:a,orderBy:"Days",orderType:"Descending",onlyOwned:!0,excludeExp:!0,onlyPlayed:!0}),b.onlyOwned&&(g+="&own=1"),b.excludeExp&&(g+="&excludesubtype=boardgameexpansion"),b.onlyPlayed&&(g+="&played=1"),window.collections.gamePlays.comparator=window.collections.gamePlays.getComparator(b.orderBy,b.orderType),window.collections.gamePlays.reset(),$.ajax({url:g,dataType:"xml",type:"GET",async:!1,success:function(a){var b=$(a);b.find("items").find("item").each(function(){c.push($(this).attr("objectid")),d[$(this).attr("objectid")]={id:$(this).attr("objectid"),title:$(this).find("name").text(),image:$(this).find("thumbnail").text(),lastPlay:"No play has been recorded",time:"N/A",timeMilis:-1,totalPlays:$(this).find("numplays").text()}})},error:function(){console.log("Entro al error")}});e;)g="/bggData/plays?username="+a+"&page="+f,$.ajax({url:g,dataType:"xml",type:"GET",async:!1,success:function(a){var b=$(a),g=null;if(b.find("plays").children().length>0){var h=b.find("plays").attr("userid");b.find("plays").find("play").each(function(){if(g=$(this).find("item").attr("objectid"),-1!=$.inArray(g,c)&&("No play has been recorded"==d[g].lastPlay||d[g].lastPlay<$(this).attr("date"))){d[g].userId=h,d[g].lastPlay=$(this).attr("date");var a=new Date,b=new Date(d[g].lastPlay.substring(0,4),d[g].lastPlay.substring(5,7)-1,d[g].lastPlay.substring(8,10)),e=new Date(d[g].lastPlay.substring(0,4),d[g].lastPlay.substring(5,7)-1,1),f=12*(a.getFullYear()-b.getFullYear());f-=b.getMonth(),f+=a.getMonth(),b.getDate()>a.getDate()&&(f-=1),0>=f&&(f=0),d[g].timeMilis=a.getTime()-b.getTime();var i=parseInt(f/12),j=f%12;e.setMonth(e.getMonth()+j+12*i),e.setDate(b.getDate());var k=parseInt((a.getTime()-e.getTime())/864e5);d[g].time=i+" year(s) "+j+" month(s) "+k+" day(s)"}}),f++}else e=!1},error:function(){console.log("Entro al error"),e=!1}});for(key in d){var h=new LastPlaysGamesByBGGUser.Models.GameItem(d[key]);window.collections.gamePlays.add(h)}window.views.orderFilter.render(a),window.views.orderFilter.$el.appendTo("body header"),window.collections.gamePlays.render()}}),LastPlaysGamesByBGGUser.Views.InputFormView=Backbone.View.extend({events:{"click #search":"searchGames","keypress #bggUser":"searchGamesEnter"},className:"",initialize:function(a){this.$el=a,this.template=_.template($("#inputForm_tpl").html())},render:function(){var a={};return this.$el.html(this.template({data:a})),this},searchGames:function(){var a={bggUser:$("#bggUser").val().trim(),orderBy:$("#orderBy").val(),orderType:$("#orderType").val(),onlyOwned:$("#onlyOwned").is(":checked"),excludeExp:$("#excludeExpansions").is(":checked"),onlyPlayed:$("#onlyPlayed").is(":checked")};$("#bggUser").removeClass("badInput"),$("#bggUser").focus(function(){$("#bggUser").removeClass("badInput")}),0==a.bggUser.length?$("#bggUser").addClass("badInput"):($.cookie(a.bggUser,JSON.stringify(a),{expires:365,path:"/"}),Backbone.history.navigate("plays/"+a.bggUser,{trigger:!0}))},searchGamesEnter:function(a){13==a.keyCode&&this.searchGames()}}),LastPlaysGamesByBGGUser.Views.PlaysView=Backbone.View.extend({events:{show:"show",click:"toggleExpand"},className:"",initialize:function(a){this.playData=a,this.expanded=0,this.template=_.template($("#PlaysView_tpl").html())},render:function(){var a={data:this.playData.toJSON()};return this.$el.html(this.template(a)),this},toggleExpand:function(){0==this.expanded?(this.$el.find(".gameItem").attr("class","extendedGameItem"),this.expanded=1):(this.$el.find(".extendedGameItem").attr("class","gameItem"),this.expanded=0)}}),LastPlaysGamesByBGGUser.Views.OrderFilterView=Backbone.View.extend({events:{},className:"",initialize:function(){this.template=_.template($("#OrderFilter_tpl").html())},render:function(a){var b=this,c=null;return this.$el.html(this.template({data:{}})),null!=$.cookie(a)&&(c=JSON.parse($.cookie(a))),null==c&&(c={bggUser:a,orderBy:"Days",orderType:"Descending",onlyOwned:!0,excludeExp:!0,onlyPlayed:!0}),this.$el.find("#filterOrderBy").val(c.orderBy),this.$el.find("#filterOrderType").val(c.orderType),this.$el.find("#filterToggle").on("click",function(){"filterFormShow"===b.$el.find("#filterForm").attr("class")?b.$el.find("#filterForm").attr("class","filterFormHidden"):b.$el.find("#filterForm").attr("class","filterFormShow")}),this.$el.find("#reOrder").on("click",function(){var a=b.$el.find("#filterOrderBy").val(),c=b.$el.find("#filterOrderType").val();window.collections.gamePlays.comparator=window.collections.gamePlays.getComparator(a,c),window.collections.gamePlays.sort(),window.collections.gamePlays.render()}),this}});